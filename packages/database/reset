#!/usr/bin/env zsh

set -e

function dump () {
  local dir=$(mktemp -d)
  local prod_dump="$dir/baf-dump"
  local saved_content="$dir/baf-saved-content"

  echo "> Saving local data"
  pg_dump \
    -t accounts \
    -t users \
    -t claims \
    --data-only -Fc \
    $DATABASE_URL > $saved_content

  echo "> Dumping production data"
  pg_dump \
    -t jobs \
    -t books \
    -t contributions \
    -t images \
    -t links \
    -t profiles \
    -t publishers \
    -t tags \
    -t features \
    -t _books_tags \
    -t _profiles_jobs \
    -t _authored_books \
    -t featured_profiles \
    -t frequently_asked_questions \
    --data-only -Fc \
    $PROD_DATABASE_URL > $prod_dump

  echo "> Resetting local database"
  if npx -w packages/database prisma migrate reset; then
    echo "> Restoring production data"
    pg_restore --disable-triggers -d $DATABASE_URL $prod_dump || true
  fi

  echo "> Restoring local data"
  pg_restore --disable-triggers -d $DATABASE_URL $saved_content || true

  echo "> Cleaning up"
  rm -rf $dir
}

db_dir=${0:a:h}
export $(cat "$db_dir/.env" | grep -v '^#' | xargs)
if [[ -z "$DATABASE_URL" ]]; then
  echo "DATABASE_URL not set"
  exit 1
fi
if [[ -z "$PROD_DATABASE_URL" ]]; then
  echo "PROD_DATABASE_URL not set"
  exit 1
fi

dump
echo "âœ… Success"
