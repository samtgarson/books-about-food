#!/usr/bin/env zsh

set -e

function dump () {
  local tmpfile=$(mktemp -t baf-backup.XXXXXX.sql)
  pg_dump \
    -t jobs \
    -t books \
    -t contributions \
    -t images \
    -t links \
    -t profiles \
    -t publishers \
    -t tags \
    -t _books_tags \
    -t _profiles_jobs \
    --data-only \
    $PROD_DATABASE_URL > $tmpfile \
    && psql -d $DATABASE_URL -f $tmpfile || true
  rm $tmpfile
}

db_dir=${0:a:h}
export $(cat "$db_dir/.env" | xargs)
if [[ -z "$DATABASE_URL" ]]; then
  echo "DATABASE_URL not set"
  exit 1
fi
if [[ -z "$PROD_DATABASE_URL" ]]; then
  echo "PROD_DATABASE_URL not set"
  exit 1
fi
dump || rm /tmp/baf-backup.XXXXXX.sql
